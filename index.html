<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xsukax Pie Chart Maker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .main-container { background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .slice-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 2px solid #e9ecef; transition: all 0.3s; }
        .slice-item:hover { border-color: #667eea; box-shadow: 0 2px 8px rgba(102,126,234,0.2); }
        .color-picker-wrapper { position: relative; width: 50px; height: 50px; }
        .color-picker-wrapper input[type="color"] { width: 100%; height: 100%; border-radius: 8px; border: 3px solid #dee2e6; cursor: pointer; }
        .color-picker-wrapper input[type="color"]:hover { border-color: #667eea; }
        #preview { min-height: 500px; background: white; border-radius: 12px; padding: 30px; display: flex; align-items: center; justify-content: center; }
        .toast-container { z-index: 9999; }
        .card-header { border-bottom: 3px solid #667eea !important; }
        .btn-add-slice { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; }
        .btn-add-slice:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1 fs-3">
                <i class="bi bi-pie-chart-fill"></i> xsukax Pie Chart Maker
            </span>
            <div class="d-flex gap-2">
                <button class="btn btn-light" onclick="exportAsPNG()" title="Export as PNG">
                    <i class="bi bi-image"></i> PNG
                </button>
                <button class="btn btn-light" onclick="exportAsSVG()" title="Export as SVG">
                    <i class="bi bi-filetype-svg"></i> SVG
                </button>
                <button class="btn btn-light" onclick="exportAsMarkdown()" title="Export as Markdown">
                    <i class="bi bi-filetype-md"></i> MD
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="main-container p-4">
            <div class="row g-4">
                <div class="col-lg-5">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0 text-primary"><i class="bi bi-sliders"></i> Chart Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label class="form-label fw-bold text-secondary">
                                    <i class="bi bi-fonts"></i> Chart Title
                                </label>
                                <input type="text" id="chartTitle" class="form-control form-control-lg" 
                                       placeholder="Enter chart title" value="My Pie Chart">
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label fw-bold mb-0 text-secondary">
                                    <i class="bi bi-pie-chart"></i> Chart Slices
                                </label>
                                <button class="btn btn-primary btn-add-slice" onclick="addSlice()">
                                    <i class="bi bi-plus-circle"></i> Add Slice
                                </button>
                            </div>

                            <div id="slicesList" class="mb-3"></div>

                            <div class="alert alert-info d-flex align-items-center" role="alert">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <small>Click color boxes to change slice colors. Minimum 2 slices required.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0 text-primary"><i class="bi bi-eye"></i> Live Preview</h5>
                        </div>
                        <div class="card-body">
                            <div id="preview"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.0/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'base',
            themeVariables: {
                primaryColor: '#ffffff'
            }
        });

        const defaultColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E74C3C', '#3498DB'];
        let slices = [
            { label: 'Category A', value: 30, color: defaultColors[0] },
            { label: 'Category B', value: 25, color: defaultColors[1] },
            { label: 'Category C', value: 20, color: defaultColors[2] },
            { label: 'Category D', value: 15, color: defaultColors[3] },
            { label: 'Category E', value: 10, color: defaultColors[4] }
        ];

        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            const iconClass = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
            const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
            
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${iconClass}"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        function renderSlices() {
            const slicesList = document.getElementById('slicesList');
            slicesList.innerHTML = '';

            slices.forEach((slice, index) => {
                const sliceHTML = `
                    <div class="slice-item">
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <div class="color-picker-wrapper">
                                    <input type="color" id="color-${index}" value="${slice.color}" 
                                           class="form-control form-control-color" 
                                           onchange="updateSliceColor(${index}, this.value)"
                                           title="Choose color">
                                </div>
                            </div>
                            <div class="col">
                                <input type="text" value="${slice.label}" 
                                       class="form-control" placeholder="Slice Label"
                                       onchange="updateSliceLabel(${index}, this.value)">
                            </div>
                            <div class="col-auto" style="width: 100px;">
                                <input type="number" value="${slice.value}" min="0" step="0.1"
                                       class="form-control" placeholder="Value"
                                       onchange="updateSliceValue(${index}, this.value)">
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-danger" onclick="removeSlice(${index})" 
                                        ${slices.length <= 2 ? 'disabled' : ''}
                                        title="${slices.length <= 2 ? 'Minimum 2 slices required' : 'Remove slice'}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                slicesList.insertAdjacentHTML('beforeend', sliceHTML);
            });

            renderChart();
        }

        function addSlice() {
            const nextColor = defaultColors[slices.length % defaultColors.length];
            slices.push({
                label: `Category ${String.fromCharCode(65 + slices.length)}`,
                value: 10,
                color: nextColor
            });
            renderSlices();
            showToast('Slice added successfully!');
        }

        function removeSlice(index) {
            if (slices.length <= 2) {
                showToast('Chart must have at least 2 slices', 'error');
                return;
            }
            slices.splice(index, 1);
            renderSlices();
            showToast('Slice removed successfully!');
        }

        function updateSliceLabel(index, value) {
            slices[index].label = value || `Slice ${index + 1}`;
            renderChart();
        }

        function updateSliceValue(index, value) {
            const numValue = parseFloat(value);
            slices[index].value = isNaN(numValue) || numValue < 0 ? 0 : numValue;
            renderChart();
        }

        function updateSliceColor(index, value) {
            slices[index].color = value;
            renderChart();
        }

        function generateMermaidCode(includeColors = false) {
            const title = document.getElementById('chartTitle').value || 'Pie Chart';
            
            let code = '';
            
            // Include color configuration if requested
            if (includeColors) {
                code += `%%{init: {'theme':'base', 'themeVariables': {`;
                slices.forEach((slice, index) => {
                    code += `'pie${index + 1}':'${slice.color}'`;
                    if (index < slices.length - 1) code += ', ';
                });
                code += `}}}%%\n`;
            } else {
                code += `%%{init: {'theme':'base'}}%%\n`;
            }
            
            code += `pie title ${title}\n`;
            
            slices.forEach(slice => {
                const value = slice.value || 0;
                code += `    "${slice.label}" : ${value}\n`;
            });
            
            return code;
        }

        async function renderChart() {
            const preview = document.getElementById('preview');
            const code = generateMermaidCode();
            
            try {
                preview.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                
                const id = 'mermaid-' + Date.now();
                const { svg } = await mermaid.render(id, code);
                preview.innerHTML = svg;
                
                // Apply custom colors to pie slices and legend
                setTimeout(() => {
                    const svgElement = preview.querySelector('svg');
                    if (!svgElement) return;
                    
                    // Find all path elements that are pie slices
                    const allPaths = svgElement.querySelectorAll('path');
                    const slicePaths = Array.from(allPaths).filter(path => {
                        const d = path.getAttribute('d');
                        return d && (d.includes('A') || d.includes('a'));
                    });
                    
                    // Apply colors to each slice
                    slicePaths.forEach((path, index) => {
                        if (index < slices.length) {
                            path.setAttribute('fill', slices[index].color);
                            path.style.fill = slices[index].color;
                        }
                    });
                    
                    // Apply colors to legend rectangles
                    const legendRects = svgElement.querySelectorAll('rect.legend-box, g.legend rect');
                    legendRects.forEach((rect, index) => {
                        if (index < slices.length) {
                            rect.setAttribute('fill', slices[index].color);
                            rect.style.fill = slices[index].color;
                        }
                    });
                    
                    // Also try to find legend items by other selectors
                    const allRects = svgElement.querySelectorAll('rect');
                    const smallRects = Array.from(allRects).filter(rect => {
                        const width = parseFloat(rect.getAttribute('width'));
                        const height = parseFloat(rect.getAttribute('height'));
                        return width < 50 && height < 50 && width > 5 && height > 5;
                    });
                    
                    smallRects.forEach((rect, index) => {
                        if (index < slices.length) {
                            rect.setAttribute('fill', slices[index].color);
                            rect.style.fill = slices[index].color;
                        }
                    });
                }, 50);
            } catch (error) {
                preview.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-circle"></i> 
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function exportAsPNG() {
            const svgElement = document.querySelector('#preview svg');
            if (!svgElement) {
                showToast('No chart to export', 'error');
                return;
            }

            try {
                // Clone the SVG to avoid modifying the displayed one
                const clonedSvg = svgElement.cloneNode(true);
                
                // Get original dimensions
                const bbox = svgElement.getBBox();
                const originalWidth = bbox.width;
                const originalHeight = bbox.height;
                
                // Scale factor for high resolution (3x for better quality)
                const scale = 3;
                const width = originalWidth * scale;
                const height = originalHeight * scale;
                
                // Set dimensions on cloned SVG
                clonedSvg.setAttribute('width', width);
                clonedSvg.setAttribute('height', height);
                clonedSvg.setAttribute('viewBox', `${bbox.x} ${bbox.y} ${originalWidth} ${originalHeight}`);
                
                const svgData = new XMLSerializer().serializeToString(clonedSvg);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Transparent background (no fill)
                    ctx.clearRect(0, 0, width, height);
                    
                    // Draw the image
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((blob) => {
                        const link = document.createElement('a');
                        link.download = 'xsukax-pie-chart.png';
                        link.href = URL.createObjectURL(blob);
                        link.click();
                        URL.revokeObjectURL(url);
                        URL.revokeObjectURL(link.href);
                        showToast('Chart exported as PNG successfully! (High resolution with transparent background)');
                    }, 'image/png');
                };
                
                img.onerror = () => {
                    showToast('Failed to load image for export', 'error');
                    URL.revokeObjectURL(url);
                };
                
                img.src = url;
            } catch (error) {
                showToast('Failed to export PNG: ' + error.message, 'error');
            }
        }

        function exportAsSVG() {
            const svgElement = document.querySelector('#preview svg');
            if (!svgElement) {
                showToast('No chart to export', 'error');
                return;
            }

            try {
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const link = document.createElement('a');
                link.download = 'xsukax-pie-chart.svg';
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
                showToast('Chart exported as SVG successfully!');
            } catch (error) {
                showToast('Failed to export SVG: ' + error.message, 'error');
            }
        }

        function exportAsMarkdown() {
            const code = generateMermaidCode(true); // Include colors in markdown export
            
            try {
                const markdown = '```mermaid\n' + code + '\n```';
                const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
                const link = document.createElement('a');
                link.download = 'xsukax-pie-chart.md';
                link.href = URL.createObjectURL(blob);
                link.click();
                URL.revokeObjectURL(link.href);
                showToast('Chart exported as Markdown with custom colors!');
            } catch (error) {
                showToast('Failed to export Markdown: ' + error.message, 'error');
            }
        }

        // Event listeners
        document.getElementById('chartTitle').addEventListener('input', () => {
            clearTimeout(window.titleTimeout);
            window.titleTimeout = setTimeout(renderChart, 300);
        });

        // Initialize
        renderSlices();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>